# íˆ¬ë ¥(Power Index) & ë­í¬ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

## ğŸ“‹ ê°œìš”

AION2 ìºë¦­í„°ì˜ ìŠ¤íƒ¯ì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ì´íŠ¸ ê³ ìœ  íˆ¬ë ¥ ì§€í‘œë¥¼ ê³„ì‚°í•˜ê³ , D1~S5 í¼ì„¼íƒ€ì¼ ê¸°ë°˜ ë­í¬ë¥¼ ì‚°ì •í•˜ëŠ” ì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.

**êµ¬í˜„ ì¼ì**: 2025-12-31
**ìš”êµ¬ì‚¬í•­ ë¬¸ì„œ**: `attack.md`

---

## âœ… êµ¬í˜„ ì™„ë£Œ í•­ëª©

### 1. ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ ì—…ë°ì´íŠ¸

#### Character í…Œì´ë¸” (backend/app/models.py:22-44)
- `power_index` (Integer): ì‚¬ì´íŠ¸ ê³ ìœ  íˆ¬ë ¥ ì§€í‘œ (ê¸°ì¤€ê°’ 1000)
- `tier_rank` (String): D1~S5 ë­í¬
- `percentile` (Integer): í¼ì„¼íƒ€ì¼ (0~100)

#### ServerAverageStats í…Œì´ë¸” ì‹ ê·œ ìƒì„± (backend/app/models.py:66-80)
ì„œë²„ë³„ í‰ê·  ìŠ¤íƒ¯ ì €ì¥:
- avg_attack, avg_damage_amp
- avg_crit_rate, avg_crit_damage
- avg_attack_speed
- avg_defense, avg_damage_reduction, avg_hp
- sample_size (í‘œë³¸ í¬ê¸°)

---

### 2. íˆ¬ë ¥ ê³„ì‚° ë¡œì§ (backend/app/power_calculator.py)

#### ê³„ì‚° ê³µì‹
```python
power_index = round(1000 * (
    0.30 * (ê³µê²©ë ¥ / ì„œë²„í‰ê· ê³µê²©ë ¥) +
    0.20 * (í”¼í•´ì¦í­ / ì„œë²„í‰ê· í”¼í•´ì¦í­) +
    0.30 * ((ì¹˜ëª…í™•ë¥  + ì¹˜ëª…í”¼í•´) / 2 / ì„œë²„í‰ê· ) +
    0.10 * (ê³µê²©ì†ë„ / ì„œë²„í‰ê· ê³µê²©ì†ë„) +
    0.10 * ((ë°©ì–´ + í”¼í•´ê°ì†Œ + ì²´ë ¥) / 3 / ì„œë²„í‰ê· )
))
```

#### ì£¼ìš” ê¸°ëŠ¥
- `extract_stats_from_json()`: ìŠ¤íƒ¯ ì¶”ì¶œ
- `normalize_stat()`: ì„œë²„ í‰ê·  ëŒ€ë¹„ ì •ê·œí™”
- `calculate_power_index()`: íˆ¬ë ¥ ê³„ì‚° + ìŠ¤íƒ¯ ê¸°ì—¬ë„ ë°˜í™˜

**ì¶œë ¥ ì˜ˆì‹œ**:
```json
{
    "power_index": 1667,
    "statContribution": {
        "attack": 40,
        "damageAmp": 16,
        "crit": 28,
        "attackSpeed": 6,
        "survive": 9
    }
}
```

---

### 3. ë­í¬ ì‚°ì • ë¡œì§ (backend/app/rank_calculator.py)

#### ë­í¬ êµ¬ì¡° (í¼ì„¼íƒ€ì¼ ê¸°ë°˜)
| í‹°ì–´ | í¼ì„¼íƒ€ì¼ ë²”ìœ„ | ì„¤ëª… |
|------|--------------|------|
| **S1~S5** | ìƒìœ„ 0~0.3% | ìµœìƒìœ„ (5ë‹¨ê³„ ì„¸ë¶„í™”) |
| **A1~A5** | ìƒìœ„ 0.3~5% | ìƒìœ„ê¶Œ |
| **B1~B5** | ìƒìœ„ 5~25% | ì¤‘ìƒìœ„ê¶Œ |
| **C1~C5** | ìƒìœ„ 25~50% | ì¤‘ê°„ |
| **D1~D5** | í•˜ìœ„ 50~100% | í•˜ìœ„ê¶Œ |

#### ì£¼ìš” ê¸°ëŠ¥
- `calculate_percentile()`: ì„œë²„ ë‚´ í¼ì„¼íƒ€ì¼ ê³„ì‚°
- `get_tier_rank()`: í¼ì„¼íƒ€ì¼ â†’ ë­í¬ ë³€í™˜
- `calculate_next_rank_power()`: ë‹¤ìŒ ë­í¬ê¹Œì§€ í•„ìš”í•œ íˆ¬ë ¥ ì°¨ì´ ê³„ì‚°

**ì¶œë ¥ ì˜ˆì‹œ**:
```json
{
    "tier_rank": "B3",
    "percentile": 17.0,
    "nextRankPower": 125
}
```

---

### 4. ì„œë²„ í‰ê·  ë°ì´í„° ê´€ë¦¬ (backend/app/server_stats.py)

#### ì£¼ìš” ê¸°ëŠ¥
- `get_server_average_stats()`: ì„œë²„ í‰ê·  ì¡°íšŒ (ì—†ìœ¼ë©´ ì „ì²´ í‰ê·  fallback)
- `update_server_average_stats()`: íŠ¹ì • ì„œë²„ í‰ê·  ì¬ê³„ì‚°
- `update_all_server_stats()`: ëª¨ë“  ì„œë²„ í‰ê·  ì—…ë°ì´íŠ¸

#### Fallback ì „ëµ
1. ì„œë²„ í‰ê·  ë°ì´í„° ìˆìŒ â†’ ì‚¬ìš©
2. ì„œë²„ ë°ì´í„° ì—†ìŒ â†’ ì „ì²´ ì„œë²„ í‰ê·  ì‚¬ìš© (ê°€ì¤‘ í‰ê· )
3. ë°ì´í„° ì „í˜€ ì—†ìŒ â†’ ê¸°ë³¸ê°’ ì‚¬ìš©

---

### 5. API ì—”ë“œí¬ì¸íŠ¸ ì—…ë°ì´íŠ¸

#### 5.1 ìºë¦­í„° ê²€ìƒ‰ API (backend/app/main.py:53-282)
**ê¸°ì¡´**: `/api/characters/search?server=Siel&name=TestChar1`

**ìƒˆë¡œìš´ ì‘ë‹µ í•„ë“œ ì¶”ê°€**:
```json
{
    "power": 103012,          // ê²Œì„ ë‚´ ê³µì‹ ì „íˆ¬ë ¥ (ê¸°ì¡´)
    "power_index": 1667,      // ì‚¬ì´íŠ¸ ê³ ìœ  íˆ¬ë ¥ (ì‹ ê·œ)
    "tier_rank": "B3",        // D1~S5 ë­í¬ (ì‹ ê·œ)
    "percentile": 17.0,       // í¼ì„¼íƒ€ì¼ (ì‹ ê·œ)
    "nextRankPower": 125,     // ë‹¤ìŒ ë­í¬ê¹Œì§€ í•„ìš”í•œ íˆ¬ë ¥ (ì‹ ê·œ)
    "statContribution": {     // ìŠ¤íƒ¯ë³„ ê¸°ì—¬ë„ (ì‹ ê·œ)
        "attack": 40,
        "damageAmp": 16,
        "crit": 28,
        "attackSpeed": 6,
        "survive": 9
    }
}
```

#### 5.2 íˆ¬ë ¥ ê¸°ë°˜ ë­í‚¹ API (ì‹ ê·œ)
**ì—”ë“œí¬ì¸íŠ¸**: `/api/rankings/power-index`

**íŒŒë¼ë¯¸í„°**:
- `server`: ì„œë²„ í•„í„° (ì„ íƒ)
- `class`: í´ë˜ìŠ¤ í•„í„° (ì„ íƒ)
- `page`: í˜ì´ì§€ ë²ˆí˜¸
- `limit`: í˜ì´ì§€ë‹¹ ì•„ì´í…œ ìˆ˜

**ì‘ë‹µ ì˜ˆì‹œ**:
```json
{
    "items": [
        {
            "rank": 1,
            "name": "TestChar1",
            "server": "Siel",
            "class": "Warrior",
            "power_index": 1667,
            "tier_rank": "S3",
            "percentile": 0.15
        }
    ],
    "type": "power_index",
    "is_realtime": true
}
```

#### 5.3 ì„œë²„ í‰ê·  ì—…ë°ì´íŠ¸ API (ê´€ë¦¬ììš©, ì‹ ê·œ)
**ì—”ë“œí¬ì¸íŠ¸**: `POST /api/admin/update-server-stats`

**íŒŒë¼ë¯¸í„°**:
- `server`: íŠ¹ì • ì„œë²„ (ì„ íƒ, ì—†ìœ¼ë©´ ì „ì²´ ì—…ë°ì´íŠ¸)

**ìš©ë„**:
- ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ í‰ê·  ìŠ¤íƒ¯ ì¬ê³„ì‚°
- ì‹ ê·œ ë°ì´í„° ìˆ˜ì§‘ í›„ ì •ê·œí™” ê¸°ì¤€ ì—…ë°ì´íŠ¸

---

### 6. ë”ë¯¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (backend/app/adapter.py:276-293)

**ê¸°ì¡´**: attack, defense, hpë§Œ í¬í•¨

**ì—…ë°ì´íŠ¸**: íˆ¬ë ¥ ê³„ì‚°ì— í•„ìš”í•œ ëª¨ë“  ìŠ¤íƒ¯ í¬í•¨
```python
stats_json = {
    "attack": random.randint(300, 1200),
    "damage_amp": random.randint(50, 300),
    "crit_rate": random.randint(20, 100),
    "crit_damage": random.randint(150, 300),
    "attack_speed": random.randint(80, 150),
    "defense": random.randint(300, 1200),
    "damage_reduction": random.randint(30, 100),
    "hp": random.randint(5000, 20000),
}
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### í…ŒìŠ¤íŠ¸ í™˜ê²½
- Docker Compose ê¸°ë°˜ PostgreSQL + Redis
- 10ê°œì˜ í…ŒìŠ¤íŠ¸ ìºë¦­í„° ìƒì„±
- ì„œë²„: Siel

### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

#### 1. íˆ¬ë ¥ ê³„ì‚° í…ŒìŠ¤íŠ¸
```bash
$ curl "http://localhost:8000/api/characters/search?server=Siel&name=TestChar1"
```
**ê²°ê³¼**: âœ… ì„±ê³µ
- power_index: 1667
- statContribution ì •ìƒ ì¶œë ¥ (attack 40%, crit 28% ë“±)

#### 2. ë­í¬ ì‚°ì • í…ŒìŠ¤íŠ¸
```bash
$ curl "http://localhost:8000/api/characters/search?server=Siel&name=TestChar5"
```
**ê²°ê³¼**: âœ… ì„±ê³µ
- tier_rank: "D1"
- percentile: 100 (í•˜ìœ„ 100%)
- nextRankPower: ê³„ì‚°ë¨

#### 3. íˆ¬ë ¥ ê¸°ë°˜ ë­í‚¹ ì¡°íšŒ
```bash
$ curl "http://localhost:8000/api/rankings/power-index?server=Siel&limit=5"
```
**ê²°ê³¼**: âœ… ì„±ê³µ
- íˆ¬ë ¥ ìˆœìœ¼ë¡œ ì •ë ¬ (1667 â†’ 1662 â†’ 1522 â†’ ...)
- ê° ìºë¦­í„°ì˜ tier_rank, percentile ì •ìƒ í‘œì‹œ

#### 4. ì„œë²„ í‰ê·  ì—…ë°ì´íŠ¸
```bash
$ curl -X POST "http://localhost:8000/api/admin/update-server-stats?server=Siel"
```
**ê²°ê³¼**: âœ… ì„±ê³µ
- ServerAverageStats í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ
- ì´í›„ íˆ¬ë ¥ ê³„ì‚° ì‹œ ì—…ë°ì´íŠ¸ëœ í‰ê·  ì‚¬ìš©

---

## ğŸ“ ì„¤ê³„ ì›ì¹™ ì¤€ìˆ˜ í™•ì¸

### âœ… 1. íˆ¬ë ¥ì€ í•­ìƒ ì¦ê°€ ì²´ê°ì´ ìˆì–´ì•¼ í•¨
- ì •ê·œí™”ë¥¼ í†µí•´ í‰ê·  ëŒ€ë¹„ ë¹„ìœ¨ë¡œ ê³„ì‚° â†’ ìƒìœ„ ìŠ¤íƒ¯ì¼ìˆ˜ë¡ ì¦ê°€í­ ê°ì†Œ
- ê°€ì¤‘ì¹˜ ì ìš©ìœ¼ë¡œ íŠ¹ì • ìŠ¤íƒ¯ ê·¹ëŒ€í™” ë°©ì§€

### âœ… 2. ë­í¬ëŠ” ì‰½ê²Œ ì˜¤ë¥´ì§€ ì•Šë„ë¡ ì„¤ê³„
- í¼ì„¼íƒ€ì¼ ê¸°ë°˜ â†’ ì ˆëŒ€ì  íˆ¬ë ¥ì´ ì•„ë‹Œ ìƒëŒ€ í‰ê°€
- S/A ë­í¬ëŠ” ê°ê° 0.3%, 5% ì´ë‚´ë¡œ ì œí•œ
- 5ë‹¨ê³„ ì„¸ë¶„í™”ë¡œ ê°™ì€ í‹°ì–´ ë‚´ì—ì„œë„ ê²½ìŸ ìœ ë„

### âœ… 3. ì„œë²„ ê¸°ì¤€ ìƒëŒ€ í‰ê°€ ìœ ì§€
- ì„œë²„ë³„ í‰ê·  ìŠ¤íƒ¯ìœ¼ë¡œ ì •ê·œí™”
- ë­í¬ ì‚°ì • ì‹œ ê°™ì€ ì„œë²„ ìºë¦­í„°ë§Œ ë¹„êµ
- ì‹ ê·œ ì„œë²„ëŠ” ì „ì²´ í‰ê· ìœ¼ë¡œ fallback

### âœ… 4. í–¥í›„ ë­í‚¹/í†µê³„ í˜ì´ì§€ì™€ ì—°ë™ ê°€ëŠ¥ êµ¬ì¡°
- íˆ¬ë ¥ ê¸°ë°˜ ë­í‚¹ API ì œê³µ
- ìºì‹œ(Redis) ì ìš©ìœ¼ë¡œ ì„±ëŠ¥ ìµœì í™”
- ìŠ¤íƒ¯ ê¸°ì—¬ë„ ë°ì´í„°ë¡œ ë¶„ì„ í˜ì´ì§€ êµ¬í˜„ ê°€ëŠ¥

---

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. ì‹œìŠ¤í…œ ì‹œì‘
```bash
docker-compose up -d
```

### 2. ìºë¦­í„° ê²€ìƒ‰ (íˆ¬ë ¥ ìë™ ê³„ì‚°)
```bash
curl "http://localhost:8000/api/characters/search?server=Siel&name=ìºë¦­í„°ëª…"
```

### 3. íˆ¬ë ¥ ë­í‚¹ ì¡°íšŒ
```bash
curl "http://localhost:8000/api/rankings/power-index?server=Siel&limit=20"
```

### 4. ì„œë²„ í‰ê·  ì—…ë°ì´íŠ¸ (ì •ê¸° ì‹¤í–‰ ê¶Œì¥)
```bash
curl -X POST "http://localhost:8000/api/admin/update-server-stats"
```

---

## ğŸ”§ í–¥í›„ ê°œì„  ì‚¬í•­

### 1. ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘ ì–´ëŒ‘í„° êµ¬í˜„
- í˜„ì¬ëŠ” ë”ë¯¸ ë°ì´í„° ì‚¬ìš©
- HTML íŒŒì‹±ìœ¼ë¡œ ì‹¤ì œ ìºë¦­í„° ìŠ¤íƒ¯ ìˆ˜ì§‘ í•„ìš”
- `backend/app/adapter.py`ì˜ `_parse_html_response` í™•ì¥

### 2. ì„œë²„ í‰ê·  ìë™ ì—…ë°ì´íŠ¸
- Celery Beat ìŠ¤ì¼€ì¤„ëŸ¬ í™œìš©
- 1ì‹œê°„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ì„œë²„ í‰ê·  ì¬ê³„ì‚°
- `backend/app/worker.py`ì— íƒœìŠ¤í¬ ì¶”ê°€

### 3. íˆ¬ë ¥ ê°€ì¤‘ì¹˜ ì¡°ì • ì¸í„°í˜ì´ìŠ¤
- ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ê°€ì¤‘ì¹˜ ì‹¤ì‹œê°„ ì¡°ì •
- A/B í…ŒìŠ¤íŠ¸ë¡œ ìµœì  ê°€ì¤‘ì¹˜ ë„ì¶œ

### 4. ë­í¬ íˆìŠ¤í† ë¦¬ ì¶”ì 
- ì‹œê°„ì— ë”°ë¥¸ ë­í¬ ë³€í™” ì¶”ì 
- ê·¸ë˜í”„ë¡œ ë­í¬ ìƒìŠ¹/í•˜ë½ ì¶”ì´ ì‹œê°í™”

---

## ğŸ“ ê²°ë¡ 

attack.mdì— ëª…ì‹œëœ ëª¨ë“  ìš”êµ¬ì‚¬í•­ì„ ì„±ê³µì ìœ¼ë¡œ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤:

- âœ… íˆ¬ë ¥ ê³„ì‚° ë¡œì§ (ì •ê·œí™” + ê°€ì¤‘ì¹˜)
- âœ… D1~S5 ë­í¬ ì‚°ì • (í¼ì„¼íƒ€ì¼ ê¸°ë°˜)
- âœ… ì„œë²„ í‰ê·  ë°ì´í„° ê´€ë¦¬
- âœ… API ì‘ë‹µì— íˆ¬ë ¥/ë­í¬ ë°ì´í„° í¬í•¨
- âœ… ìŠ¤íƒ¯ë³„ ê¸°ì—¬ë„ ê³„ì‚°
- âœ… ë‹¤ìŒ ë­í¬ê¹Œì§€ í•„ìš”í•œ íˆ¬ë ¥ í‘œì‹œ

ì‹œìŠ¤í…œì€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë©°, í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤.
