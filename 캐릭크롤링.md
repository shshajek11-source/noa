# 아이온2 랭킹 캐릭터 크롤링 시스템 설계도

## 1. 개요

아이온2 공식 사이트의 랭킹 데이터를 크롤링하여 우리 DB에 저장하는 시스템

### 목표
- 7개 랭킹 컨텐츠의 모든 캐릭터 데이터 수집
- 42개 서버(천족 21개 + 마족 21개) 전체 커버
- 안전한 속도로 크롤링 (Rate Limiting)
- 중복 데이터 스킵 (효율성)
- 수동 실행 (관리자가 원할 때만)

---

## 2. 데이터 구조

### 2.1 서버 목록 (42개)

| 종족 | 서버 ID 범위 | 서버 수 |
|------|-------------|--------|
| 천족 (Elyos) | 1001 ~ 1021 | 21개 |
| 마족 (Asmodian) | 2001 ~ 2021 | 21개 |

### 2.2 랭킹 컨텐츠 타입

| 컨텐츠 | API Type | 설명 |
|--------|----------|------|
| 어비스 포인트 | 1 | 어비스 포인트 랭킹 |
| 초월 | 2 | 초월 컨텐츠 랭킹 |
| 악몽 | 3 | 악몽 던전 랭킹 |
| 고독의 투기장 | 4 | 솔로 PvP 랭킹 |
| 협력의 투기장 | 5 | 팀 PvP 랭킹 |
| 토벌전 | 6 | 레이드 랭킹 |
| 각성전 | 7 | 각성 컨텐츠 랭킹 |

> ⚠️ **확인 필요**: 실제 API 호출로 정확한 type 값 검증 필요

### 2.3 공식 API 엔드포인트

```
GET https://aion2.plaync.com/api/ranking/list
  ?lang=ko
  &rankingContentsType={1-7}
  &rankingType=0
  &serverId={1001-2021}
  &characterId=
```

### 2.4 API 응답 구조 (예상)

```json
{
  "rankingList": [
    {
      "rank": 1,
      "characterId": "xxx",
      "characterName": "캐릭터명",
      "className": "검성",
      "profileImage": "/path/to/image.jpg",
      "point": 12345,
      "gradeName": "등급명",
      "winCount": 10,
      "playCount": 15
    }
  ]
}
```

---

## 3. 크롤링 전략

### 3.1 Rate Limiting (속도 제한)

```
┌─────────────────────────────────────────────┐
│ 안전한 크롤링 속도 설정                       │
├─────────────────────────────────────────────┤
│ • 요청 간 딜레이: 1000ms (1초)               │
│ • 서버당 딜레이: 2000ms (2초)                │
│ • 컨텐츠 타입 변경 시: 3000ms (3초)          │
│ • 에러 발생 시 재시도 딜레이: 5000ms (5초)   │
│ • 최대 재시도 횟수: 3회                      │
└─────────────────────────────────────────────┘
```

### 3.2 크롤링 순서

```
for each 컨텐츠타입 (1~7):
    for each 서버 (1001~1021, 2001~2021):
        fetch 랭킹 데이터
        upsert to DB (중복 스킵)
        wait 1초
    wait 3초 (다음 컨텐츠)
```

### 3.3 예상 소요 시간

| 항목 | 계산 |
|------|------|
| 총 API 호출 수 | 7 컨텐츠 × 42 서버 = 294회 |
| 요청당 시간 | ~1.5초 (대기 + 응답) |
| 서버 간 대기 | 42 × 2초 = 84초/컨텐츠 |
| 컨텐츠 간 대기 | 7 × 3초 = 21초 |
| **총 예상 시간** | **약 15~20분** |

---

## 4. DB 스키마

### 4.1 characters 테이블 (기존)

```sql
-- 기존 컬럼 활용 + 신규 추가 필요 시
characters (
  id SERIAL PRIMARY KEY,
  character_id TEXT UNIQUE,      -- 공식 캐릭터 ID
  name TEXT,
  server_id INTEGER,
  race_name TEXT,                -- 'Elyos' | 'Asmodian'
  class_name TEXT,
  level INTEGER,
  profile_image TEXT,

  -- 랭킹 데이터 (신규/확장)
  ranking_abyss INTEGER,         -- 어비스 순위
  ranking_transcendence INTEGER, -- 초월 순위
  ranking_nightmare INTEGER,     -- 악몽 순위
  ranking_solitude INTEGER,      -- 고독 순위
  ranking_cooperation INTEGER,   -- 협력 순위
  ranking_conquest INTEGER,      -- 토벌 순위
  ranking_awakening INTEGER,     -- 각성 순위

  -- 포인트/점수
  point_abyss INTEGER,
  point_transcendence INTEGER,
  point_nightmare INTEGER,
  point_solitude INTEGER,
  point_cooperation INTEGER,
  point_conquest INTEGER,
  point_awakening INTEGER,

  -- 메타
  rankings JSONB,                -- 상세 랭킹 데이터 (백업용)
  crawled_at TIMESTAMP,          -- 마지막 크롤링 시간
  updated_at TIMESTAMP
)
```

### 4.2 crawl_jobs 테이블 (신규)

```sql
CREATE TABLE crawl_jobs (
  id SERIAL PRIMARY KEY,
  job_type TEXT,                 -- 'full' | 'partial'
  status TEXT,                   -- 'pending' | 'running' | 'completed' | 'failed'
  progress JSONB,                -- { current: 50, total: 294, currentServer: '지켈' }
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  error_message TEXT,
  stats JSONB                    -- { inserted: 1000, updated: 500, skipped: 200 }
);
```

---

## 5. API 설계

### 5.1 크롤링 시작 API

```
POST /api/admin/crawl/start
Body: {
  "contentTypes": [1, 2, 3, 4, 5, 6, 7],  // 선택적
  "serverIds": [1001, 2002],              // 선택적 (빈 배열 = 전체)
  "skipExisting": true                    // 이미 있는 캐릭터 스킵
}

Response: {
  "jobId": "job_12345",
  "status": "started",
  "estimatedTime": "15분"
}
```

### 5.2 크롤링 상태 확인 API

```
GET /api/admin/crawl/status?jobId=job_12345

Response: {
  "jobId": "job_12345",
  "status": "running",
  "progress": {
    "current": 50,
    "total": 294,
    "percentage": 17,
    "currentContent": "어비스",
    "currentServer": "지켈"
  },
  "stats": {
    "inserted": 500,
    "updated": 200,
    "skipped": 100,
    "errors": 2
  }
}
```

### 5.3 크롤링 중단 API

```
POST /api/admin/crawl/stop
Body: { "jobId": "job_12345" }
```

---

## 6. 구현 파일 구조

```
frontend/src/app/
├── api/admin/
│   ├── crawl/
│   │   ├── start/route.ts       # 크롤링 시작
│   │   ├── status/route.ts      # 상태 확인
│   │   └── stop/route.ts        # 중단
│   ├── stats/route.ts           # 통계 API
│   └── logs/route.ts            # 로그 API
├── components/admin/
│   ├── AdminSidebar.tsx         # 사이드바 네비게이션
│   ├── AdminHeader.tsx          # 헤더
│   ├── DashboardStats.tsx       # 대시보드 통계 카드
│   ├── CrawlManager.tsx         # 크롤링 관리 컴포넌트
│   ├── DataManager.tsx          # 데이터 관리 컴포넌트
│   └── SystemStatus.tsx         # 시스템 상태 컴포넌트
└── admin/
    ├── layout.tsx               # 어드민 레이아웃
    ├── page.tsx                 # 대시보드 메인
    ├── crawl/page.tsx           # 크롤링 관리
    ├── data/page.tsx            # 데이터 관리
    └── settings/page.tsx        # 설정
```

---

## 6.1 어드민 대시보드 설계

### 전체 레이아웃

```
┌────────────────────────────────────────────────────────────────────┐
│  🎮 AION2 Admin                              [관리자] [로그아웃]    │
├──────────┬─────────────────────────────────────────────────────────┤
│          │                                                         │
│  📊 대시보드 │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│          │  │ 총 캐릭터 │ │ 오늘 추가 │ │ DB 크기  │ │ API 호출 │    │
│  🔄 크롤링  │  │ 15,234  │ │   +523  │ │  2.3GB  │ │ 1,234   │    │
│          │  └─────────┘ └─────────┘ └─────────┘ └─────────┘    │
│  📁 데이터  │                                                         │
│          │  ┌───────────────────────────────────────────────────┐  │
│  ⚙️ 설정   │  │ 🔄 크롤링 상태                                    │  │
│          │  │ ████████████░░░░░░░░  50/294 (17%)               │  │
│  📋 로그   │  │ 현재: 어비스 > 지켈 서버                          │  │
│          │  └───────────────────────────────────────────────────┘  │
│          │                                                         │
│          │  ┌───────────────────────┐ ┌───────────────────────┐  │
│          │  │ 📈 서버별 캐릭터 분포    │ │ 📊 직업별 분포         │  │
│          │  │     [차트]            │ │     [차트]            │  │
│          │  └───────────────────────┘ └───────────────────────┘  │
│          │                                                         │
│          │  ┌───────────────────────────────────────────────────┐  │
│          │  │ 📋 최근 활동 로그                                  │  │
│          │  │ [12:30] 크롤링 완료 - 지켈 서버 (523건)           │  │
│          │  │ [12:25] 크롤링 시작 - 어비스 컨텐츠               │  │
│          │  └───────────────────────────────────────────────────┘  │
└──────────┴─────────────────────────────────────────────────────────┘
```

### 메뉴 구조

| 메뉴 | 경로 | 기능 |
|------|------|------|
| 📊 대시보드 | `/admin` | 전체 현황, 통계, 빠른 액션 |
| 🔄 크롤링 | `/admin/crawl` | 랭킹 크롤링 시작/중단/모니터링 |
| 📁 데이터 | `/admin/data` | 캐릭터 데이터 검색/수정/삭제 |
| ⚙️ 설정 | `/admin/settings` | API 키, Rate Limit 등 설정 |
| 📋 로그 | `/admin/logs` | 시스템 로그 조회 |

### 대시보드 위젯

```
┌──────────────────────────────────────────────────────────────┐
│ 📊 통계 카드 (상단)                                           │
├──────────────────────────────────────────────────────────────┤
│ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ │
│ │ 👥 총 캐릭터 │ │ ➕ 오늘 추가 │ │ 🗄️ DB 크기  │ │ 🌐 API 호출 │ │
│ │   15,234   │ │    +523    │ │   2.3 GB   │ │   1,234    │ │
│ │ ▲ 5.2%    │ │ ▲ 12.3%   │ │ ▲ 0.8%    │ │ 오늘       │ │
│ └────────────┘ └────────────┘ └────────────┘ └────────────┘ │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ ⚡ 빠른 액션 (Quick Actions)                                  │
├──────────────────────────────────────────────────────────────┤
│ [🔄 전체 크롤링] [📥 어비스만] [🧹 캐시 정리] [📊 리포트]      │
└──────────────────────────────────────────────────────────────┘

┌────────────────────────────┐ ┌────────────────────────────┐
│ 🔄 크롤링 상태              │ │ 🖥️ 시스템 상태              │
├────────────────────────────┤ ├────────────────────────────┤
│ 상태: 실행 중               │ │ DB 연결: ✅ 정상           │
│ ████████░░░░  67%          │ │ API 서버: ✅ 정상          │
│ 현재: 악몽 > 트리니엘       │ │ 캐시: ✅ 정상              │
│ 예상 완료: 12분 후          │ │ 디스크: 78% 사용           │
│ [일시정지] [중단]           │ │ 메모리: 2.1GB / 4GB       │
└────────────────────────────┘ └────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ 📋 최근 활동                                                  │
├──────────────────────────────────────────────────────────────┤
│ 🟢 [14:32:15] 크롤링 완료 - 지켈 서버 (523건 추가)           │
│ 🟢 [14:30:05] 크롤링 시작 - 어비스 컨텐츠                    │
│ 🟡 [14:25:00] 데이터 정리 - 중복 12건 제거                   │
│ 🔴 [14:20:30] API 에러 - Rate Limit 초과 (5초 후 재시도)     │
│ 🟢 [14:15:00] 시스템 시작                                    │
└──────────────────────────────────────────────────────────────┘
```

---

## 7. 보안 및 개선 사항

### 7.1 보안 (필수)

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| 🔐 관리자 인증 | API 키 또는 세션 기반 인증 | 높음 |
| 🛡️ Rate Limit | 클라이언트 측 요청 제한 | 높음 |
| 📝 로깅 | 모든 크롤링 활동 기록 | 중간 |
| 🚫 IP 차단 대응 | 프록시 로테이션 (옵션) | 낮음 |

### 7.2 안정성 개선

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| 🔄 재시도 로직 | 실패 시 3회까지 재시도 | 높음 |
| 💾 체크포인트 | 중단 후 이어서 실행 가능 | 높음 |
| ⚡ 배치 처리 | 100건씩 DB 일괄 저장 | 중간 |
| 📊 진행률 표시 | 실시간 진행 상황 UI | 중간 |

### 7.3 효율성 개선

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| ⏭️ 중복 스킵 | character_id로 존재 여부 확인 | 높음 |
| 🕐 마지막 크롤링 시간 | 24시간 이내면 스킵 옵션 | 중간 |
| 📦 델타 업데이트 | 변경된 데이터만 업데이트 | 중간 |
| 🗜️ 응답 압축 | gzip 압축 요청 | 낮음 |

---

## 8. 관리자 UI 설계

```
┌──────────────────────────────────────────────────────────┐
│  🔄 랭킹 캐릭터 크롤링                                    │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 컨텐츠 선택                                         │ │
│  │ ☑️ 어비스  ☑️ 초월  ☑️ 악몽  ☑️ 고독                │ │
│  │ ☑️ 협력   ☑️ 토벌  ☑️ 각성                         │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 서버 선택                                           │ │
│  │ ◉ 전체 서버 (42개)                                  │ │
│  │ ○ 천족만 (21개)                                     │ │
│  │ ○ 마족만 (21개)                                     │ │
│  │ ○ 특정 서버 선택 [▼ 드롭다운]                       │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                          │
│  ☑️ 이미 가져온 캐릭터 스킵                              │
│  ☑️ 24시간 이내 업데이트된 데이터 스킵                   │
│                                                          │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 예상 소요 시간: 약 15분                             │ │
│  │ 예상 API 호출: 294회                                │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                          │
│         [ 🚀 크롤링 시작 ]    [ ❌ 중단 ]                │
│                                                          │
├──────────────────────────────────────────────────────────┤
│  📊 진행 상황                                            │
│  ████████████░░░░░░░░  50/294 (17%)                     │
│                                                          │
│  현재: 어비스 > 지켈 서버                                │
│  삽입: 500건 | 업데이트: 200건 | 스킵: 100건            │
│  경과 시간: 5분 32초                                     │
│                                                          │
├──────────────────────────────────────────────────────────┤
│  📋 로그                                                 │
│  [12:30:15] 어비스 - 시엘 서버 완료 (50건)              │
│  [12:30:17] 어비스 - 네자칸 서버 시작...                │
│  [12:30:18] 어비스 - 네자칸 서버 완료 (48건)            │
│  ...                                                     │
└──────────────────────────────────────────────────────────┘
```

---

## 9. 구현 순서 (권장)

### Phase 1: 기본 기능 (필수)
1. [ ] 랭킹 타입별 API type 값 검증
2. [ ] `/api/admin/crawl/start` 구현
3. [ ] DB 스키마 확장 (ranking_* 컬럼)
4. [ ] 기본 크롤링 로직 (단일 서버 테스트)

### Phase 2: 안정성
5. [ ] Rate Limiting 적용
6. [ ] 재시도 로직
7. [ ] 에러 핸들링
8. [ ] 진행률 저장 (crawl_jobs 테이블)

### Phase 3: UI
9. [ ] 관리자 페이지 생성
10. [ ] 실시간 진행률 표시
11. [ ] 로그 뷰어

### Phase 4: 최적화
12. [ ] 배치 upsert
13. [ ] 중복 스킵 최적화
14. [ ] 체크포인트 (이어서 실행)

---

## 10. 주의사항

### ⚠️ 법적/윤리적 고려
- 공식 API를 과도하게 호출하지 않도록 Rate Limit 준수
- robots.txt 확인
- 서비스 약관 검토 권장

### ⚠️ 기술적 고려
- 공식 API 변경 시 대응 필요
- IP 차단 가능성 대비 (프록시 옵션)
- 서버 부하 고려 (피크 시간 피하기)

---

## 11. 다음 단계

설계도 검토 후 구현 시작하려면:
1. 먼저 랭킹 타입별 실제 API 응답 테스트
2. Phase 1부터 순차 구현
3. 테스트 서버 1개로 먼저 검증 후 전체 확장

---

*최종 수정: 2025-01-07*
