# AION2 능력치 추출 시스템 문서

> 캐릭터 능력치를 다양한 소스에서 추출하고 집계하는 시스템

**작성일**: 2025-01-13
**파일**: `frontend/src/lib/statsAggregator.ts`

---

## 📋 목차

1. [시스템 개요](#시스템-개요)
2. [데이터 소스](#데이터-소스)
3. [파싱 로직](#파싱-로직)
4. [집계 프로세스](#집계-프로세스)
5. [카테고리 분류](#카테고리-분류)
6. [색상 표시](#색상-표시)

---

## 시스템 개요

### 핵심 함수

```typescript
aggregateStats(equipment, titles, daevanion, stats): StatDetail[]
```

4개의 데이터 소스에서 능력치를 추출하고 집계하여 통합된 능력치 배열을 반환합니다.

### 처리 흐름

```
데이터 입력 (4개 소스)
    ↓
각 소스별 추출
    ↓
문자열 파싱
    ↓
스탯별 집계
    ↓
정렬 및 반환
```

---

## 데이터 소스

### 1️⃣ 장비 (Equipment)

**추출 함수**: `extractEquipmentStats(equipment: any[])`

#### UI에서 보이는 위치

**캐릭터 페이지 > 중앙 영역 > "장비" 탭**

3개 섹션으로 구분:
- **"무기 / 방어구"**: 주무기, 보조무기, 투구, 견갑, 흉갑, 장갑, 각반, 장화, 망토, 허리띠
- **"장신구 / 룬"**: 귀걸이, 아뮬렛, 목걸이, 반지, 팔찌, 룬
- **"펫 / 날개"**: 펫, 날개

각 장비 아이템을 클릭하면 나타나는 툴팁의 능력치 정보가 추출됩니다.

#### API 데이터 구조

```typescript
equipment[] → item → {
  name: string                    // 아이템 이름 (화면에 표시)
  manastones?: Manastone[]        // 루트 레벨 마석
  detail?: {                      // 툴팁 상세 정보
    options?: Option[]            // 기본 옵션 (흰색 텍스트)
    randomOptions?: Option[]      // 랜덤 옵션 (초록색 텍스트)
    manastones?: Manastone[]      // 디테일 레벨 마석 (보라색 아이콘)
  }
}
```

#### 추출되는 데이터

| 데이터 유형 | 경로 | 라벨 형식 | 예시 |
|-----------|------|----------|------|
| **기본 옵션** | `detail.options[].name + value` | `{아이템명}` | "바크론의 장갑" |
| **랜덤 옵션** | `detail.randomOptions[].name + value` | `{아이템명} (옵션)` | "바크론의 흉갑 (옵션)" |
| **마석 (루트)** | `manastones[].type` or `.name` | `{아이템명} (마석)` | "바크론의 장갑 (마석)" |
| **마석 (디테일)** | `detail.manastones[].type` or `.name` | `{아이템명} (마석)` | "누아쿰의 각반 (마석)" |

#### 실제 데이터 예시

```json
{
  "name": "바크론의 장갑",
  "detail": {
    "options": [
      { "name": "방어력", "value": "189 (+145)" },
      { "name": "생명력", "value": "108 (+110)" }
    ],
    "randomOptions": [
      { "name": "명중", "value": "+21" },
      { "name": "정신력", "value": "+48" }
    ],
    "manastones": [
      { "type": "생명력 +60" },
      { "type": "정신력 +50" }
    ]
  }
}
```

**파싱 결과**:
- 방어력: 189 + 145 = **334**
- 생명력: 108 + 110 = **218**
- 명중: **21**
- 정신력: **48** (옵션), **50** (마석)

---

### 2️⃣ 타이틀 (Titles)

**추출 함수**: `extractTitleStats(titles: any)`

#### UI에서 보이는 위치

**캐릭터 페이지 > 우측 사이드바 > "타이틀" 섹션**

각 타이틀 카드에 표시되는 능력치 효과들이 추출됩니다.

#### API 데이터 구조

```typescript
titles → {
  titleList: Title[]        ← "타이틀" 섹션에 표시되는 타이틀들
} → Title → {
  name: string
  equipped: boolean         ← 현재 장착 중인지 여부
  statList?: Stat[]         // 보유 효과 (• 표시)
  equipStatList?: Stat[]    // 장착 효과 (현재 장착 중일 때만 적용)
}
```

#### 추출되는 데이터

| 데이터 유형 | 조건 | 경로 | 라벨 형식 | 예시 |
|-----------|-----|------|----------|------|
| **보유 효과** | 항상 | `statList[].desc` | `{타이틀명}` | "알트가르드 수호자" |
| **장착 효과** | `equipped === true` | `equipStatList[].desc` | `{타이틀명} (장착)` | "알트가르드 수호자 (장착)" |

#### 실제 데이터 예시

```json
{
  "name": "지켈의 근원을 마주하다",
  "equipped": false,
  "statList": [
    { "desc": "생명력 물약 회복 +550" },
    { "desc": "이동 속도 +5%" },
    { "desc": "생명력 +800" }
  ]
}
```

**파싱 결과** (보유 효과만):
- 생명력 물약 회복: **550**
- 이동 속도: **5%**
- 생명력: **800**

---

### 3️⃣ 대바니온 (Daevanion)

**추출 함수**: `extractDaevanionStats(daevanion: any)`

#### UI에서 보이는 위치

**캐릭터 페이지 > 우측 사이드바 > "데바니온" 섹션**

6개의 신 보드 현황이 표시됩니다:
- 네자칸: 85/88
- 지켈: 75/88
- 바이젤: 81/88
- 트리니엘: 103/116
- 아리엘: 9/152
- 아스펠: 5/152

#### ⚠️ 중요 사항

대바니온 효과는 **별도로 추출하지 않습니다**.

대바니온을 통해 얻은 신 스탯은 **"주요 능력치" 섹션**에 자동으로 포함되어 있습니다.
- 예: `정의[네자칸]: 76`, `시간[시엘]: 96` 등

이 신 스탯들의 `statSecondList`가 "능력치 통합 뷰"에 표시됩니다.

#### 대바니온 효과가 반영되는 실제 위치

**"주요 능력치" 섹션 (우측 사이드바)**에 신 스탯으로 표시:
```
주요 능력치
  ├─ 위력: 115
  ├─ 민첩: 20
  ├─ 정의[네자칸]: 76    ← 대바니온으로 얻은 신 스탯
  ├─ 시간[시엘]: 96      ← 대바니온으로 얻은 신 스탯
  └─ 죽음[트리니엘]: 77  ← 대바니온으로 얻은 신 스탯
```

#### API 데이터 구조 예시

```json
{
  "name": "정의[네자칸]",
  "value": 76,
  "statSecondList": [          ← 이 리스트의 스탯들이 "능력치 통합 뷰"에 추가됨
    "방어력 증가 +15.2%",
    "막기 증가 +13.6%"
  ]
}
```

따라서 별도로 대바니온 API를 호출하거나 데이터를 추출할 필요가 없습니다.

#### 함수 구현

```typescript
function extractDaevanionStats(daevanion: any): Map<string, StatSource[]> {
  // 빈 Map 반환 (대바니온 효과는 기본 스탯에 포함됨)
  return new Map<string, StatSource[]>()
}
```

---

### 4️⃣ 기본 스탯 (Base Stats)

**추출 함수**: `extractBaseStats(stats: any)`

#### UI에서 보이는 위치

**캐릭터 페이지 > 우측 사이드바 > "주요 능력치" 섹션**

이 섹션에 표시되는 모든 스탯(`위력`, `민첩`, `지식`, `체력`, `정의[네자칸]` 등)의 `statSecondList`가 "능력치 통합 뷰"의 원본 데이터입니다.

#### API 데이터 구조

```typescript
stats → {
  statList: BaseStat[]      ← "주요 능력치" 섹션에 표시되는 스탯들
} → BaseStat → {
  name: string              // "위력", "민첩", "정의[네자칸]" 등
  value: number             // 115, 76 등
  statSecondList: string[]  // 2차 파생 능력치 → "능력치 통합 뷰"에 표시됨
}
```

#### 추출되는 데이터

| 데이터 유형 | 경로 | 라벨 형식 | 예시 |
|-----------|------|----------|------|
| **2차 파생 능력치** | `statSecondList[]` | `{기본스탯명} ({값})` | "위력 (115)" |

#### 실제 데이터 예시

```json
{
  "statList": [
    {
      "name": "위력",
      "value": 115,
      "statSecondList": [
        "공격력 +880",
        "공격력 증가 +15.5%",
        "치명타 +310",
        "명중 +228"
      ]
    },
    {
      "name": "정의[네자칸]",
      "value": 76,
      "statSecondList": [
        "방어력 증가 +15.2%",
        "막기 증가 +13.6%"
      ]
    }
  ]
}
```

**파싱 결과**:
- 공격력: **880** (from 위력 115)
- 공격력 증가: **15.5%** (from 위력 115)
- 치명타: **310** (from 위력 115)
- 명중: **228** (from 위력 115)
- 방어력 증가: **15.2%** (from 정의[네자칸] 76)
- 막기 증가: **13.6%** (from 정의[네자칸] 76)

---

## 파싱 로직

### parseStatString 함수

능력치 문자열을 파싱하여 구조화된 데이터로 변환합니다.

#### 지원하는 형식

##### 1. 퍼센트 형식
```typescript
// 정규식: /(.+?)\s*[+\-]?\s*(\d+(?:\.\d+)?)\s*%/

"공격력 증가 +5%"      → { name: "공격력 증가", value: 0, percentage: 5 }
"치명타 +10.5%"        → { name: "치명타", value: 0, percentage: 10.5 }
"방어력 증가 +15.2%"   → { name: "방어력 증가", value: 0, percentage: 15.2 }
```

##### 2. 기본값 + 추가 보너스 (⭐ 신규)
```typescript
// 정규식: /(.+?)\s*[:+\-]?\s*(\d+(?:,\d+)*)\s*\(\+(\d+(?:,\d+)*)\)/

"생명력 1100 (+350)"   → { name: "생명력", value: 1450, percentage: 0 }
"방어력 189 (+145)"    → { name: "방어력", value: 334, percentage: 0 }
"공격력 500 (+100)"    → { name: "공격력", value: 600, percentage: 0 }
```

**⚠️ 중요**: 기본값과 보너스를 **합산**하여 반환합니다!

##### 3. 고정값만
```typescript
// 정규식: /(.+?)\s*[:+\-]?\s*(\d+(?:,\d+)*)/

"공격력 +100"          → { name: "공격력", value: 100, percentage: 0 }
"방어력: 200"          → { name: "방어력", value: 200, percentage: 0 }
"생명력 1000"          → { name: "생명력", value: 1000, percentage: 0 }
"치명타 +1,500"        → { name: "치명타", value: 1500, percentage: 0 }
```

**⚠️ 중요**: 쉼표(,)는 자동으로 제거됩니다!

#### 파싱 우선순위

1. **퍼센트** → 먼저 체크
2. **기본값 + 보너스** → 두 번째 체크
3. **고정값** → 마지막 체크

이 순서는 매우 중요합니다! 잘못된 순서는 파싱 오류를 일으킬 수 있습니다.

---

## 집계 프로세스

### 1단계: 소스별 추출

```typescript
const equipmentStats = extractEquipmentStats(equipment)    // Map<스탯명, StatSource[]>
const titleStats = extractTitleStats(titles)              // Map<스탯명, StatSource[]>
const daevanionStats = extractDaevanionStats(daevanion)   // Map<스탯명, StatSource[]> (비어있음)
const baseStats = extractBaseStats(stats)                 // Map<스탯명, StatSource[]>
```

### 2단계: 스탯 이름 수집

```typescript
const allStatNames = new Set<string>()
// 모든 소스에서 나온 스탯 이름들을 수집
// 예: "생명력", "공격력", "방어력 증가", ...
```

### 3단계: 스탯별 집계

각 스탯 이름에 대해:

```typescript
// 1. 각 소스에서 해당 스탯의 기여도 가져오기
const equipSources = equipmentStats.get("생명력") || []
const titleSources = titleStats.get("생명력") || []
const baseSources = baseStats.get("생명력") || []

// 2. 고정값 합산
const totalValue =
  equipSources.reduce((sum, s) => sum + s.value, 0) +    // 장비: 2190
  titleSources.reduce((sum, s) => sum + s.value, 0) +    // 타이틀: 800
  baseSources.reduce((sum, s) => sum + s.value, 0)       // 기본스탯: 352

// totalValue = 3342

// 3. 퍼센트 합산
const totalPercentage =
  equipSources.reduce((sum, s) => sum + (s.percentage || 0), 0) +
  titleSources.reduce((sum, s) => sum + (s.percentage || 0), 0) +
  baseSources.reduce((sum, s) => sum + (s.percentage || 0), 0)

// 4. StatDetail 객체 생성
{
  name: "생명력",
  totalValue: 3342,
  totalPercentage: 15.6,
  sources: {
    equipment: [...],
    titles: [...],
    daevanion: [],
    baseStats: [...]
  },
  color: "#10B981",
  category: "defense",
  isExpanded: false
}
```

### 4단계: 정렬

```typescript
// 총합 값 기준 내림차순 정렬
statDetails.sort((a, b) => {
  const aTotal = a.totalValue + a.totalPercentage
  const bTotal = b.totalValue + b.totalPercentage
  return bTotal - aTotal
})
```

---

## 카테고리 분류

### STAT_CATEGORY_MAP

능력치를 4개 카테고리로 분류합니다.

```typescript
type StatCategory = 'attack' | 'defense' | 'critical' | 'utility' | 'all'
```

#### 공격 (attack)
- 공격력
- 위력
- 강타
- 명중

#### 방어 (defense)
- 방어력
- 생명력
- 체력
- 막기
- 회피
- 철벽
- 치명타 저항
- 완벽 저항
- 강타 저항

#### 치명 (critical)
- 치명타
- 치명타 공격력
- 치명타 피해
- 완벽

#### 유틸리티 (utility)
- 정신력
- 전투 속도
- 이동 속도
- 재사용 시간
- 정신력 소모량
- 재생
- **기타 모든 스탯** (매핑되지 않은 경우 기본값)

---

## 색상 표시

### STAT_THRESHOLDS

능력치 값에 따라 색상을 다르게 표시합니다.

```typescript
interface StatColorThreshold {
  high: number      // 빨강
  medium: number    // 노랑
  low: number       // 초록
  // 그 외 → 파랑
}
```

#### 임계값 테이블

| 스탯 | 파랑 (< low) | 초록 (≥ low) | 노랑 (≥ medium) | 빨강 (≥ high) |
|-----|-------------|-------------|----------------|--------------|
| **공격력** | < 1000 | 1000+ | 1500+ | 2000+ |
| **방어력** | < 600 | 600+ | 1000+ | 1500+ |
| **치명타** | < 200 | 200+ | 350+ | 500+ |
| **치명타 공격력** | < 100 | 100+ | 200+ | 300+ |
| **명중** | < 200 | 200+ | 350+ | 500+ |
| **회피** | < 150 | 150+ | 250+ | 400+ |
| **생명력** | < 5000 | 5000+ | 7000+ | 10000+ |
| **정신력** | < 2000 | 2000+ | 3500+ | 5000+ |
| **막기** | < 150 | 150+ | 250+ | 400+ |
| **전투 속도** | < 100 | 100+ | 200+ | 300+ |
| **이동 속도** | < 100 | 100+ | 150+ | 200+ |
| **기타** | - | 회색 (#9CA3AF) | - | - |

#### 색상 코드

- 🔴 빨강 (높음): `#EF4444`
- 🟡 노랑 (보통-높음): `#FBBF24`
- 🟢 초록 (보통): `#10B981`
- 🔵 파랑 (낮음): `#3B82F6`
- ⚫ 회색 (기본): `#9CA3AF`

---

## 데이터 타입 정의

### StatSource
```typescript
interface StatSource {
  name: string                   // "바크론의 장갑", "위력 (115)"
  value: number                  // 218, 880
  percentage?: number            // 5, 15.2 (옵션)
  description?: string           // "보유 효과", "기본 스탯" (옵션)
}
```

### StatSources
```typescript
interface StatSources {
  equipment: StatSource[]        // 장비별 기여도
  titles: StatSource[]           // 타이틀별 기여도
  daevanion: StatSource[]        // 대바니온별 기여도 (현재 비어있음)
  baseValue: number              // 하위 호환용 (사용 안 함)
  baseStats?: StatSource[]       // 기본 스탯별 기여도
}
```

### StatDetail
```typescript
interface StatDetail {
  name: string                   // "생명력"
  totalValue: number             // 3342
  totalPercentage: number        // 15.6
  sources: StatSources
  color: string                  // "#10B981"
  category: StatCategory         // "defense"
  isExpanded?: boolean           // 아코디언 펼침 상태
}
```

---

## 실제 데이터 예시

### 생명력 스탯의 전체 추출 과정

#### 입력 데이터

**1. 장비 (Equipment)**
```json
[
  {
    "name": "바크론의 투구",
    "detail": {
      "options": [{ "name": "생명력", "value": "1175 (+1175)" }]
    }
  },
  {
    "name": "바크론의 장갑",
    "detail": {
      "options": [{ "name": "생명력", "value": "108 (+110)" }]
    }
  }
]
```

**2. 타이틀 (Titles)**
```json
{
  "titleList": [
    {
      "name": "지켈의 근원을 마주하다",
      "statList": [
        { "desc": "생명력 +800" }
      ]
    }
  ]
}
```

**3. 기본 스탯 (Stats)**
```json
{
  "statList": [
    {
      "name": "체력",
      "value": 50,
      "statSecondList": [
        "생명력 +352"
      ]
    }
  ]
}
```

#### 추출 결과

```typescript
{
  name: "생명력",
  totalValue: 3620,  // 2350 + 218 + 800 + 352
  totalPercentage: 0,
  sources: {
    equipment: [
      { name: "바크론의 투구", value: 2350, percentage: 0 },
      { name: "바크론의 장갑", value: 218, percentage: 0 }
    ],
    titles: [
      { name: "지켈의 근원을 마주하다", value: 800, percentage: 0 }
    ],
    daevanion: [],
    baseStats: [
      { name: "체력 (50)", value: 352, percentage: 0 }
    ]
  },
  color: "#9CA3AF",
  category: "defense",
  isExpanded: false
}
```

---

## 주요 변경 이력

### 2025-01-13: 추가 보너스 파싱 로직 추가

**문제**: API에서 `"생명력 1100 (+350)"` 형식으로 데이터가 반환되는데, 괄호 안의 보너스가 무시됨

**해결**: `parseStatString` 함수에 새로운 정규식 패턴 추가

```typescript
// 패턴 2: 고정값 + 추가 보너스
const bonusMatch = statStr.match(/(.+?)\s*[:+\-]?\s*(\d+(?:,\d+)*)\s*\(\+(\d+(?:,\d+)*)\)/)
if (bonusMatch) {
  const baseValue = parseInt(bonusMatch[2].replace(/,/g, ''), 10)
  const bonusValue = parseInt(bonusMatch[3].replace(/,/g, ''), 10)
  return {
    name: bonusMatch[1].trim(),
    value: baseValue + bonusValue,  // 기본값 + 보너스 합산!
    percentage: 0
  }
}
```

**영향**: 모든 능력치가 정확하게 집계됨
- 생명력: 2,282 → 3,342 (+1,060)
- 방어력: 3,844 → 5,319 (+1,475)
- 공격력: 880 → 1,600 (+720)

---

## 문제 해결 가이드

### Q1: 능력치 총합이 맞지 않아요

**체크리스트**:
1. 브라우저 개발자 도구 콘솔 확인
2. `parseStatString` 함수가 올바르게 파싱하는지 확인
3. API 응답 데이터 형식 확인 (`"값 (+추가)"` 형식인지)
4. 개발 서버 재시작 (`.next` 캐시 정리)

### Q2: 특정 능력치가 표시되지 않아요

**확인 사항**:
1. 해당 능력치가 4개 소스 중 어디에서 나오는지 확인
2. 파싱 로직이 해당 형식을 지원하는지 확인
3. `STAT_CATEGORY_MAP`에 매핑되어 있는지 확인

### Q3: 색상이 이상하게 표시돼요

**확인 사항**:
1. `STAT_THRESHOLDS`에 해당 능력치의 임계값이 정의되어 있는지 확인
2. 값이 올바르게 계산되었는지 확인 (totalValue + totalPercentage)

---

## 추가 자료

- **메인 파일**: `frontend/src/lib/statsAggregator.ts`
- **타입 정의**: `frontend/src/types/stats.ts`
- **UI 컴포넌트**: `frontend/src/app/components/StatsSummaryView.tsx`
- **툴팁 컴포넌트**: `frontend/src/app/components/StatTooltip.tsx`

---

**문서 끝**
