<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Worker</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body style="margin: 0; padding: 20px; font-family: sans-serif; background: #1a1a1a; color: #fff;">
    <div id="status">OCR 모델 로딩 중...</div>
    <script>
        let worker = null;
        let currentLang = 'kor+eng';
        let isReady = false;

        // 부모 창에 메시지 전송
        function sendToParent(type, data, requestId = null) {
            if (window.parent !== window) {
                window.parent.postMessage({ type, data, requestId }, '*');
            }
        }

        // OCR 초기화
        async function initOcr(lang = 'kor+eng') {
            try {
                // 이미 worker가 있고 언어가 같다면 재사용 (단, 상태가 ready일 때만)
                if (worker && currentLang === lang && isReady) {
                    return;
                }

                // 언어가 바뀌면 기존 워커 종료
                if (worker) {
                    await worker.terminate();
                    worker = null;
                    isReady = false;
                }

                currentLang = lang;
                sendToParent('status', { message: `Tesseract 로딩 중 (${lang})...` });
                document.getElementById('status').textContent = `Tesseract 로딩 중 (${lang})...`;

                // Tesseract v5 createWorker
                worker = await Tesseract.createWorker(lang, 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            sendToParent('status', { message: `인식 중... ${progress}%` });
                        }
                    }
                });

                isReady = true;
                sendToParent('ready', { success: true });
                document.getElementById('status').textContent = 'OCR 준비 완료';
                console.log(`[OCR Worker] Tesseract 로드 완료 (${lang})`);
            } catch (err) {
                console.error('[OCR Worker] 초기화 실패:', err);
                document.getElementById('status').textContent = '초기화 실패: ' + err.message;
                sendToParent('error', { message: err.message });
                isReady = false;
            }
        }

        // 이미지 OCR 수행
        async function processImage(data, reqId) {
            // data = { image: string, psm: string, lang: string }
            const { image, psm, lang } = data;

            // 로컬 요청 ID (덮어쓰기 방지)
            const myRequestId = reqId;
            console.log(`[OCR Worker] 처리 시작 (ID: ${myRequestId})`);

            // 언어 변경 감지 및 초기화
            if (lang && lang !== currentLang) {
                await initOcr(lang);
            }

            if (!worker || !isReady) {
                sendToParent('error', { message: 'OCR이 준비되지 않았습니다' }, myRequestId);
                return;
            }

            try {
                // PSM 설정 check
                // Tesseract PSM enums: https://github.com/naptha/tesseract.js/blob/master/docs/api.md#psm-page-segmentation-mode
                if (psm) {
                    await worker.setParameters({
                        tessedit_pageseg_mode: psm,
                    });
                }

                sendToParent('status', { message: '텍스트 인식 중...' }, myRequestId);
                const startTime = performance.now();

                const result = await worker.recognize(image);
                const endTime = performance.now();

                // Tesseract 결과를 표준 형식으로 변환
                const texts = result.data.lines.map(line => ({
                    text: line.text.trim(),
                    confidence: line.confidence,
                    box: [[line.bbox.x0, line.bbox.y0], [line.bbox.x1, line.bbox.y0],
                    [line.bbox.x1, line.bbox.y1], [line.bbox.x0, line.bbox.y1]]
                })).filter(t => t.text.length > 0);

                console.log(`[OCR Worker] 처리 완료 (ID: ${myRequestId})`);
                sendToParent('result', {
                    texts: texts,
                    processingTime: endTime - startTime
                }, myRequestId);

            } catch (err) {
                console.error('[OCR Worker] 처리 실패:', err);
                sendToParent('error', { message: err.message }, myRequestId);
            }
        }

        // 부모 창에서 메시지 수신
        window.addEventListener('message', async (event) => {
            const { type, data, requestId } = event.data || {};

            switch (type) {
                case 'init':
                    await initOcr(data?.lang);
                    break;
                case 'process':
                    await processImage(data, requestId); // data contains {image, psm, lang}, requestId for response matching
                    break;
                case 'ping':
                    // ping 응답 (ready 상태 확인용)
                    if (isReady) {
                        sendToParent('ready', { success: true });
                    }
                    break;
            }
        });

        // 자동 초기화 (기본값)
        initOcr('kor+eng');
    </script>
</body>

</html>